sudo -u postgres psql

CREATE USER bleedah WITH PASSWORD 'password';
ALTER USER bleedah WITH SUPERUSER;

CREATE database counterkeyspace;
ALTER DATABASE counterkeyspace OWNER TO bleedah;



\q

psql bleedah -h localhost -d counterkeyspace

CREATE EXTENSION IF NOT EXISTS postgis;

CREATE TABLE counter_timeline (
  time        TIMESTAMPTZ NOT NULL,
  counter_id  INTEGER NOT NULL,
  avg_sec_gap FLOAT           NULL,
  speed       INTEGER         NULL,
  cars_per_sec INTEGER         NULL
);

SELECT AddGeometryColumn('counter_timeline','geom','4326','POINT',2);
GRANT ALL PRIVILEGES ON DATABASE counterkeyspace to bleedah;
GRANT ALL PRIVILEGES ON TABLE counter_timeline to bleedah;

CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;
select setup_timescaledb();
SELECT create_hypertable('counter_timeline', 'time');


ALTER TABLE counter_timeline ADD COLUMN id BIGINT;
CREATE SEQUENCE counter_timeline_seq START 1;
ALTER SEQUENCE counter_timeline_seq RESTART WITH 1;
UPDATE counter_timeline SET id = nextval('counter_timeline_seq');
ALTER TABLE counter_timeline ADD PRIMARY KEY (id);


INSERT INTO counter_timeline(counter_id, time, avg_sec_gap, speed, cars_per_sec)
  VALUES (?,?,?,?,?);


CREATE SEQUENCE counter_seq START 1;

CREATE TABLE counter (id, code, location) AS
SELECT DISTINCT ON (ct.counter_id, ct.geom) nextval('counter_seq') as id, ct.counter_id as code, ct.geom as location FROM counter_timeline ct;

CREATE INDEX counter_code_eq ON counter USING hash (code);


CREATE TABLE counter AS SELECT DISTINCT ON (ct.counter_id, ct.geom) nextval('counter_seq') as 'id', ct.counter_id as 'code', ct.geom as 'location' FROM counter_timeline ct;
GRANT ALL PRIVILEGES ON TABLE counter to bleedah;


CREATE TABLE weather_timeline (
  time        TIMESTAMPTZ NOT NULL,
  counter_id  INTEGER REFERENCES counter (id),
  rain_level INTEGER NOT NULL,
  rain_mmph FLOAT NOT NULL
);
SELECT create_hypertable('weather_timeline', 'time');


INSERT INTO observations(name, unit, timestamp, value)
		VALUES ();

CREATE TABLE sleep(
	timestamp_start bigint,
	from_time bigint,
	to_time bigint,
	sleep_hours float,
	sleep_cycles int,
	sleep_deep float,
	PRIMARY KEY(timestamp_start)
)
;

INSERT INTO sleep(id, from_time, to_time, sleep_hours, sleep_cycles, sleep_deep)
		VALUES ();